name: Publish v2.x

on:
  workflow_dispatch:
    inputs:
      releaseType:
        type: choice
        description: Release type (release for main branch, prerelease for feature branches)
        required: true
        default: prerelease
        options:
          - release
          - prerelease
          - dry-run
      branch:
        type: string
        description: Branch to create pre-release from (only applies to prerelease/dry-run).
        required: false

jobs:
  authorize:
    name: Authorize
    runs-on: ubuntu-latest
    steps:
      - name: Check branch protection
        run: |
          if [ "${{ github.event.inputs.releaseType }}" == "dry-run" ]; then
            echo "✅ Branch check skipped: dry-run mode allows any branch"
            echo "Current branch: ${{ github.ref_name }}"
            exit 0
          fi
          if [ "${{ github.ref_name }}" != "main" ]; then
            echo "❌ This workflow can only be triggered from the main branch."
            echo "Current branch: ${{ github.ref_name }}"
            exit 1
          fi
          echo "✅ Branch check passed: running from main"

      - name: ${{ github.actor }} permission check to do a release
        uses: 'lannonbr/repo-permission-check-action@2.0.2'
        with:
          permission: 'write'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [authorize]
    container:
      image: mcr.microsoft.com/playwright:v1.55.0

    steps:
      - name: Check out git repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.branch || github.ref_name }}

      - name: Run E2E tests
        uses: ./.github/actions/e2e-test
        with:
          amplitude-api-key: ${{ secrets.AMPLITUDE_API_KEY }}

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [authorize, e2e]
    if: ${{ github.event.inputs.releaseType == 'release' }}
    permissions:
      id-token: write # Required for OIDC
      contents: write
    strategy:
      matrix:
        node-version: [24.x] # Ensure npm 11.5.1 or later is installed for OIDC, node 24.6 is minimal 

    steps:
      - name: Check out git repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PUBLISH_TOKEN }}

      - name: Build and Test
        uses: ./.github/actions/build-and-test
        with:
          node-version: ${{ matrix.node-version }}

      # Only create release version when using from-git (default behavior)
      # from-package mode uses existing package.json versions and doesn't need git tags
      - name: Create release version
        run: |
          echo "Running lerna version..."
          
          # Temporarily disable exit on error to capture output even when command fails
          set +e
          OUTPUT=$(GH_TOKEN=${{ secrets.GH_PUBLISH_TOKEN }} pnpm deploy:version -y --no-private --create-release github 2>&1)
          EXIT_CODE=$?
          set -e
          
          # Always display the output first
          echo "=== Lerna Version Output ==="
          echo "$OUTPUT"
          echo "=== End Output ==="
          
          # Now handle the exit code
          if [ $EXIT_CODE -ne 0 ]; then
            echo "❌ Command failed with exit code: $EXIT_CODE"
            exit $EXIT_CODE
          fi
          
          # Check if the output indicates no changed packages
          if echo "$OUTPUT" | grep -q "No changed packages to version"; then
            echo "❌ No changed packages found to version. Failing the job."
            exit 1
          fi
          
          echo "✅ Successfully created release version"

      # Publish to NPM (also uploads minified JS and source maps to S3)
      - name: Publish Release to NPM
        run: |
          GH_TOKEN=${{ secrets.GH_PUBLISH_TOKEN }} pnpm deploy:publish
        env:
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}

  prerelease:
    name: Prerelease feature branch
    runs-on: ubuntu-latest
    needs: [authorize, e2e]
    if: ${{ github.event.inputs.releaseType == 'prerelease' || github.event.inputs.releaseType == 'dry-run' }}
    permissions:
      id-token: write # Required for OIDC
      contents: write
    strategy:
      matrix:
        node-version: [24.x] # Ensure npm 11.5.1 or later is installed for OIDC, node 24.6 is minimal

    steps:
      - name: Determine branch to use
        id: determine-branch
        run: |
          if [ -n "${{ github.event.inputs.branch }}" ]; then
            echo "branch=${{ github.event.inputs.branch }}" >> $GITHUB_OUTPUT
          else
            echo "❌ No branch specified. Please specify a branch to create pre-release from."
            exit 1
          fi

      - name: Check out git repository
        uses: actions/checkout@v3
        with:
          ref: ${{ steps.determine-branch.outputs.branch }}
          fetch-depth: 0
          token: ${{ secrets.GH_PUBLISH_TOKEN }}

      - name: Build and Test
        uses: ./.github/actions/build-and-test
        with:
          node-version: ${{ matrix.node-version }}

      # Keep alphanumeric characters and hyphens, remove other invalid characters
      # Examples:
      #   - SR-1858 -> SR-1858
      #   - feature/my-branch -> featuremy-branch
      #   - fix_bug_123 -> fixbug123
      #   - user@company.com -> usercompanycom
      - name: Transform feature branch name
        run: |
          echo "PREID=$(echo '${{ steps.determine-branch.outputs.branch }}' | tr -cd '[:alnum:]-')" >> $GITHUB_ENV

      # Use --no-push to prevent pushing to remote
      # Version example: 1.0.0 -> 1.1.0-{preid}.0
      - name: Dry run pre-release version
        if: ${{ github.event.inputs.releaseType == 'dry-run' }}
        run: |
          GH_TOKEN=${{ secrets.GH_PUBLISH_TOKEN }} pnpm deploy:version:dry-run -y --preid ${{ env.PREID }}

      - name: Pre-release version
        if: ${{ github.event.inputs.releaseType == 'prerelease' }}
        run: |
            GH_TOKEN=${{ secrets.GH_PUBLISH_TOKEN }} pnpm deploy:version -y --no-private --conventional-prerelease --preid ${{ env.PREID }} --allow-branch ${{ steps.determine-branch.outputs.branch }} --create-release github

      # Publish to NPM (also uploads minified JS and source maps to S3)
      - name: Publish Pre-release to NPM
        if: ${{ github.event.inputs.releaseType == 'prerelease' }}
        run: |
          GH_TOKEN=${{ secrets.GH_PUBLISH_TOKEN }} pnpm deploy:publish --no-git-checks --ignore-scripts --tag ${{ env.PREID }}
        env:
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}

      - name: Dry run publish release to NPM
        if: ${{ github.event.inputs.releaseType == 'dry-run' }}
        env:
          DRY_RUN: true
        run: |
          pnpm deploy:publish:dry-run
