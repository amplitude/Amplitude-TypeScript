<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/amplitude.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Request Body Compression + Transport Test</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        max-width: 640px;
        margin: 20px auto;
        padding: 0 16px;
      }
      h1 {
        font-size: 1.25rem;
      }
      .section {
        margin: 16px 0;
      }
      label {
        display: block;
        margin: 8px 0 4px;
        font-weight: 500;
      }
      select,
      input[type="text"] {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
      }
      .hint {
        font-size: 0.875rem;
        color: #666;
        margin-top: 4px;
      }
      button {
        padding: 8px 16px;
        margin: 4px 4px 4px 0;
        cursor: pointer;
      }
      #status {
        margin-top: 16px;
        padding: 12px;
        border-radius: 6px;
        font-size: 0.875rem;
      }
      #status.info {
        background: #e3f2fd;
        color: #1565c0;
      }
      #status.success {
        background: #e8f5e9;
        color: #2e7d32;
      }
      #status.warn {
        background: #fff3e0;
        color: #e65100;
      }
      .instructions {
        background: #f5f5f5;
        padding: 12px;
        border-radius: 6px;
        font-size: 0.875rem;
        margin-top: 16px;
      }
      .instructions ul {
        margin: 8px 0 0;
        padding-left: 20px;
      }
    </style>
  </head>
  <body>
    <h1>Request Body Compression + Transport Test</h1>
    <p>
      Test <code>enableRequestBodyCompression</code> with different transports (fetch, xhr, beacon).
      Use DevTools â†’ Network to verify the outgoing batch request.
    </p>

    <div class="section">
      <label for="transport">Transport</label>
      <select id="transport">
        <option value="fetch">fetch</option>
        <option value="xhr">xhr</option>
        <option value="beacon">beacon</option>
      </select>
      <div class="hint">Which HTTP transport the SDK uses to send events.</div>
    </div>

    <div class="section">
      <label>
        <input type="checkbox" id="enableCompression" checked />
        Enable request body compression
      </label>
      <div class="hint">
        When enabled (and transport supports it), the request body is gzip-compressed with
        <code>Content-Encoding: gzip</code>. Note: with default server URL, Amplitude always compresses;
        this option only applies when a custom server URL is set.
      </div>
    </div>

    <div class="section">
      <label for="serverUrl">Custom server URL (optional)</label>
      <input type="text" id="serverUrl" placeholder="e.g. https://api.amplitude.com" />
      <div class="hint">
        Leave empty to use the default Amplitude endpoint (compression is always on). Set a custom URL
        to make compression follow the checkbox above.
      </div>
    </div>

    <div class="section">
      <button id="initBtn">Apply config &amp; init</button>
      <button id="sendBtn" disabled>Send test event</button>
    </div>

    <div id="status" class="info">
      Choose options and click "Apply config &amp; init", then "Send test event". Check the Network
      tab for the batch request (type: fetch/xhr or sendBeacon) and request headers (Content-Encoding: gzip when compressed).
    </div>

    <div class="instructions">
      <strong>How to verify</strong>
      <ul>
        <li><strong>Transport:</strong> In Network tab, find the request to <code>.../batch</code> (or similar). Request type will be XHR, Fetch, or (for beacon) a beacon request.</li>
        <li><strong>Compression:</strong> In the request headers, look for <code>Content-Encoding: gzip</code>. Fetch and XHR support it; SendBeacon cannot set headers, so compression is not applied for beacon.</li>
      </ul>
    </div>

    <script type="module">
      import * as amplitude from '@amplitude/analytics-browser';
      window.amplitude = amplitude;

      const transportSelect = document.getElementById('transport');
      const enableCompressionCheckbox = document.getElementById('enableCompression');
      const serverUrlInput = document.getElementById('serverUrl');
      const initBtn = document.getElementById('initBtn');
      const sendBtn = document.getElementById('sendBtn');
      const statusEl = document.getElementById('status');

      function setStatus(message, type = 'info') {
        statusEl.textContent = message;
        statusEl.className = type;
      }

      function getConfig() {
        const transport = transportSelect.value;
        const enableRequestBodyCompression = enableCompressionCheckbox.checked;
        const serverUrl = serverUrlInput.value.trim() || undefined;
        return {
          transport,
          enableRequestBodyCompression,
          serverUrl,
        };
      }

      initBtn.addEventListener('click', () => {
        const { transport, enableRequestBodyCompression, serverUrl } = getConfig();
        try {
          amplitude.reset();
          amplitude.init(
            import.meta.env.VITE_AMPLITUDE_API_KEY,
            import.meta.env.VITE_AMPLITUDE_USER_ID || 'request-compression-test-user',
            {
              transport,
              enableRequestBodyCompression,
              ...(serverUrl ? { serverUrl } : {}),
            }
          );
          setStatus(
            `Initialized with transport=${transport}, enableRequestBodyCompression=${enableRequestBodyCompression}${serverUrl ? `, serverUrl=${serverUrl}` : ' (default server)'}. Send a test event and check the Network tab.`,
            'success'
          );
          sendBtn.disabled = false;
        } catch (e) {
          setStatus(`Init failed: ${e.message}`, 'warn');
        }
      });

      sendBtn.addEventListener('click', () => {
        amplitude.track('Request Compression Test Event', {
          transport: transportSelect.value,
          enableRequestBodyCompression: enableCompressionCheckbox.checked,
          timestamp: new Date().toISOString(),
        });
        setStatus('Test event sent. Check Network tab for the batch request.', 'success');
      });
    </script>
  </body>
</html>
