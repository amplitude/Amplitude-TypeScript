<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/amplitude.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reset and OnReset Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
      }
      h1 {
        color: #333;
      }
      .section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #f9f9f9;
      }
      button {
        margin: 5px;
        padding: 10px 15px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      button:hover {
        background-color: #0056b3;
      }
      button.danger {
        background-color: #dc3545;
      }
      button.danger:hover {
        background-color: #c82333;
      }
      button.success {
        background-color: #28a745;
      }
      button.success:hover {
        background-color: #218838;
      }
      #identity {
        font-family: monospace;
        background-color: #e9ecef;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
      }
      #logs {
        font-family: monospace;
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 10px;
      }
      .log-entry {
        margin: 5px 0;
        padding: 5px;
        border-left: 3px solid #007bff;
        background-color: white;
      }
      .log-reset {
        border-left-color: #dc3545;
      }
      .log-callback {
        border-left-color: #28a745;
      }
    </style>
  </head>
  <body>
    <h1>Reset and OnReset Test</h1>
    <p>This page demonstrates the <code>reset()</code> and <code>onReset()</code> functionality of the Amplitude Browser SDK.</p>

    <div class="section">
      <h3>Current Identity</h3>
      <button id="refreshIdentity" class="success">Refresh Identity</button>
      <div id="identity">Loading...</div>
    </div>

    <div class="section">
      <h3>Actions</h3>
      <button id="trackEvent">Track Test Event</button>
      <button id="registerCallback" class="success">Register onReset Callback</button>
      <button id="unregisterCallback" class="danger">Unregister Callback</button>
      <button id="reset" class="danger">Call reset()</button>
    </div>

    <div class="section">
      <h3>Logs</h3>
      <button id="clearLogs" class="danger">Clear Logs</button>
      <div id="logs"></div>
    </div>

    <script type="module">
      import * as amplitude from '@amplitude/analytics-browser';
      window.amplitude = amplitude;

      let unsubscribe = null;
      let callbackCount = 0;

      // Helper function to add log entries
      function addLog(message, type = '') {
        const logsDiv = document.getElementById('logs');
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logsDiv.appendChild(entry);
        logsDiv.scrollTop = logsDiv.scrollHeight;
      }

      // Helper function to update identity display
      function updateIdentity() {
        const identity = amplitude.getIdentity();
        const identityDiv = document.getElementById('identity');
        identityDiv.innerHTML = `
          <strong>User ID:</strong> ${identity.userId || '(not set)'}<br>
          <strong>Device ID:</strong> ${identity.deviceId || '(not set)'}
        `;
        addLog(`Identity refreshed - UserId: ${identity.userId || '(not set)'}, DeviceId: ${identity.deviceId}`);
      }

      // Initialize Amplitude
      amplitude.init(
        import.meta.env.VITE_AMPLITUDE_API_KEY,
        import.meta.env.VITE_AMPLITUDE_USER_ID || 'reset-test-user',
        {
          logLevel: 'DEBUG'
        }
      );

      addLog('Amplitude SDK initialized');
      updateIdentity();

      // Track Event button
      document.getElementById('trackEvent').addEventListener('click', () => {
        amplitude.track('Test Event', { timestamp: Date.now() });
        addLog('Event tracked: Test Event');
      });

      // Refresh Identity button
      document.getElementById('refreshIdentity').addEventListener('click', () => {
        updateIdentity();
      });

      // Register onReset callback button
      document.getElementById('registerCallback').addEventListener('click', () => {
        if (unsubscribe) {
          addLog('⚠️ Callback already registered! Unregister first.');
          return;
        }

        callbackCount = 0;
        unsubscribe = amplitude.onReset(() => {
          callbackCount++;
          addLog(`✓ onReset callback executed (count: ${callbackCount})`, 'log-callback');
          
          // Update identity display after reset callback
          setTimeout(updateIdentity, 100);
        });

        addLog('✓ onReset callback registered', 'log-callback');
      });

      // Unregister callback button
      document.getElementById('unregisterCallback').addEventListener('click', () => {
        if (!unsubscribe) {
          addLog('⚠️ No callback registered to unregister.');
          return;
        }

        unsubscribe();
        unsubscribe = null;
        addLog('✓ onReset callback unregistered', 'log-callback');
      });

      // Reset button
      document.getElementById('reset').addEventListener('click', () => {
        addLog('Calling reset()...', 'log-reset');
        amplitude.reset();
        addLog('✓ reset() completed', 'log-reset');
        
        // Update identity display after reset
        setTimeout(updateIdentity, 100);
      });

      // Clear logs button
      document.getElementById('clearLogs').addEventListener('click', () => {
        document.getElementById('logs').innerHTML = '';
      });
    </script>
  </body>
</html>

