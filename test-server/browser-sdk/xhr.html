<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/amplitude.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/axios@1.9.0/dist/axios.js"></script>
    <title>XHR Network Tracking Examples</title>
  </head>
  <body>
    <div id="app">
      Run a set of XHR requests to test networkTracking
      (uses axios for XHR requests)
    </div>
    <script type="module">
      import * as amplitude from '@amplitude/analytics-browser';
      window.amplitude = amplitude;
      
      // Configure Axios to not throw on error status codes
      axios.defaults.validateStatus = () => true;
      
      amplitude.init(
        import.meta.env.VITE_AMPLITUDE_API_KEY,
        import.meta.env.VITE_AMPLITUDE_USER_ID || 'amplitude-typescript test user',
        {
          autocapture: true,
          networkTrackingOptions: {
            ignoreAmplitudeRequests: false,
            ignoreHosts: [],
            captureRules: [
              {hosts: ['*.amplitude.com'], statusCodeRange: '400-599'},
              {hosts: ['httpstat.us'], statusCodeRange: '0,400-599'},
              {hosts: ['*'], statusCodeRange: '0,300-599'},
            ],
            _instrumentXHR: true,
          },
        }
      );

      setTimeout(async () => {
        let res;

        // Aborted request
        const controller = new AbortController();
        const signal = controller.signal;
        try {
          res = axios.post('https://httpstat.us/200', 'This request will be aborted', { signal });
          controller.abort(); // Abort immediately
          const awaitedRes = await res;
          if (awaitedRes.status !== 0) {
            alert(`axios.post failed with wrong status code: ${res.status}`);
          }
          console.log('This should not be logged');
        } catch (err) {
          console.log('Aborted request error:', err);
        }

        // make sure 200's still work too
        res = await axios.get('https://httpstat.us/200');
        console.log('GET 200 response:', res);
        if (res.status !== 200) {
          alert(`axios.get failed with wrong status code: ${res.status}`);
        }

        // String body
        res = await axios.post('https://httpstat.us/500', 'Hello, this is a test body');
        console.log('String body response:', res);
        if (res.status !== 500) {
          alert(`axios.post failed with wrong status code: ${res.status}`);
        }

        // JSON object body
        res = await axios.post('https://httpstat.us/501', { message: 'Hello', count: 42 });
        console.log('JSON object body response:', res);
        if (res.status !== 501) {
          alert(`axios.post failed with wrong status code: ${res.status}`);
        }

        // FormData body
        const formData = new FormData();
        formData.append('text', 'Hello from FormData');
        formData.append('file', new Blob(['Hello from Blob'], { type: 'text/plain' }));
        res = await axios.post('https://httpstat.us/502', formData);
        console.log('FormData body response:', res);
        if (res.status !== 502) {
          alert(`axios.post failed with wrong status code: ${res.status}`);
        }

        // // URLSearchParams body
        const params = new URLSearchParams();
        params.append('param1', 'value1');
        params.append('param2', 'value2');
        res = await axios.post('https://httpstat.us/504', params);
        console.log('URLSearchParams body response:', res);
        if (res.status !== 504) {
          alert(`axios.post failed with wrong status code: ${res.status}`);
        }

        // ArrayBuffer body
        const buffer = new ArrayBuffer(8);
        const view = new Uint8Array(buffer);
        view[0] = 1;
        view[1] = 2;
        res = await axios.post('https://httpstat.us/505', buffer);
        console.log('ArrayBuffer body response:', res);
        if (res.status !== 505) {
          alert(`axios.post failed with wrong status code: ${res.status}`);
        }

        // Blob body
        const blob = new Blob(['Hello from Blob'], { type: 'text/plain' });
        res = await axios.post('https://httpstat.us/506', blob);
        console.log('Blob body response:', res);
        if (res.status !== 506) {
          alert(`axios.post failed with wrong status code: ${res.status}`);
        }

        // Stream body (ReadableStream)
        const stream = new ReadableStream({
          start(controller) {
            controller.enqueue('Hello from Stream');
            controller.close();
          }
        });
        res = await axios.post('https://httpstat.us/507', stream);
        console.log('Stream body response:', res);
        if (res.status !== 507) {
          alert(`axios.post failed with wrong status code: ${res.status}`);
        }

        res = await axios.get('https://httpstat.us/508');
        console.log('GET 500 response:', res);
        if (res.status !== 508) {
          alert(`axios.get failed with wrong status code: ${res.status}`);
        }
      }, 1000);
    </script>
</html>
