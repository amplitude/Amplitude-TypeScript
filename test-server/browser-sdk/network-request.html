<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/amplitude.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Browser SDK Test</title>
  </head>
  <body>
    <div id="app">
      Basic test page for the Amplitude Browser SDK
    </div>
    <script type="module">
      import * as amplitude from '@amplitude/analytics-browser';
      window.amplitude = amplitude;
      amplitude.init(
        import.meta.env.VITE_AMPLITUDE_API_KEY,
        import.meta.env.VITE_AMPLITUDE_USER_ID || 'amplitude-typescript test user',
        {
          autocapture: true,
          networkTrackingOptions: {
            ignoreAmplitudeRequests: false,
            ignoreHosts: [],
            captureRules: [
              {hosts: ['*.amplitude.com'], statusCodeRange: '400-599'},
              {hosts: ['httpstat.us'], statusCodeRange: '400-599'},
            ],
          },
        }
      );

      async function runFetchTests() {
        const tests = [
            {
            description: "GET 200 OK",
            fetchCall: () => fetch("https://httpstat.us/200"),
            validate: async (response) => {
                console.assert(response.status === 200, "Expected status 200");
            }
            },
            {
            description: "GET with query params",
            fetchCall: () => fetch("https://httpstat.us/200?foo=bar"),
            validate: async (response) => {
                console.assert(response.status === 200, "Expected status 200 with query params");
            }
            },
            {
            description: "POST with JSON body",
            fetchCall: () => fetch("https://httpstat.us/200", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ key: "value" }),
            }),
            validate: async (response) => {
                console.assert(response.status === 200, "Expected status 200 on POST");
            }
            },
            {
            description: "PUT with custom headers",
            fetchCall: () => fetch("https://httpstat.us/200", {
                method: "PUT",
                headers: { "X-Test-Header": "TestValue" },
            }),
            validate: async (response) => {
                console.assert(response.status === 200, "Expected status 200 on PUT");
            }
            },
            {
            description: "GET 404 Not Found",
            fetchCall: () => fetch("https://httpstat.us/404"),
            validate: async (response) => {
                console.assert(response.status === 404, "Expected status 404");
            }
            },
            {
            description: "GET 500 Internal Server Error",
            fetchCall: () => fetch("https://httpstat.us/500"),
            validate: async (response) => {
                console.assert(response.status === 500, "Expected status 500");
            }
            },
            {
            description: "Network error handling (invalid domain)",
            fetchCall: () => fetch("https://nonexistent.domain.test"),
            validate: async (responsePromise) => {
                try {
                await responsePromise;
                console.assert(false, "Expected fetch to fail with network error");
                } catch (e) {
                console.assert(true, "Correctly caught network error");
                }
            }
            },
            {
            description: "AbortController timeout",
            fetchCall: () => {
                const controller = new AbortController();
                setTimeout(() => controller.abort(), 10);
                return fetch("https://httpstat.us/200?sleep=5000", { signal: controller.signal });
            },
            validate: async (responsePromise) => {
                try {
                await responsePromise;
                console.assert(false, "Expected fetch to be aborted");
                } catch (e) {
                console.assert(e.name === "AbortError", "Expected AbortError");
                }
            }
            },
            {
            description: "Stream/Blob handling",
            fetchCall: () => fetch("https://httpstat.us/200"),
            validate: async (response) => {
                const blob = await response.blob();
                console.assert(blob instanceof Blob, "Expected a Blob object");
            }
            },
            {
            description: "Text response handling",
            fetchCall: () => fetch("https://httpstat.us/200"),
            validate: async (response) => {
                const text = await response.text();
                console.assert(typeof text === "string", "Expected text response");
            }
            },
            {
            description: "JSON parsing validation",
            fetchCall: () => fetch("https://httpstat.us/200", {
                headers: { "Content-Type": "application/json" },
            }),
            validate: async (response) => {
                try {
                await response.json();
                console.assert(false, "Expected JSON parse error since httpstat.us returns plain text");
                } catch (e) {
                console.assert(true, "Correctly caught JSON parse error");
                }
            }
            },
        ];

        for (const { description, fetchCall, validate } of tests) {
            console.log(`Running test: ${description}`);
            try {
            const result = fetchCall();
            await validate(result);
            } catch (error) {
            console.error(`Error in test "${description}":`, error);
            }
        }

        console.log("All tests completed");
        };

        setTimeout(() => {
          console.log("Running fetch tests...");
          runFetchTests();
        }, 1000);

    </script>
  </body>
</html>
